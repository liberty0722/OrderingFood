<!-- pages/merchant/merchant.wxml -->
<view class="merchant-page">

  <!-- æœªç™»å½• - å¯†ç éªŒè¯ -->
  <view wx:if="{{!isLoggedIn}}" class="login-container">
    <view class="login-box">
      <view class="login-icon">ğŸ‘¨â€ğŸ³</view>
      <text class="login-title">å•†å®¶ç«¯ç™»å½•</text>
      <text class="login-desc">è¯·è¾“å…¥å•†å®¶å¯†ç è¿›å…¥è®¢å•ç®¡ç†</text>
      <input
        class="password-input"
        type="text"
        password="{{true}}"
        placeholder="è¯·è¾“å…¥å•†å®¶å¯†ç "
        value="{{passwordInput}}"
        bindinput="onPasswordInput"
        bindconfirm="onLogin"
      />
      <view class="login-btn" bindtap="onLogin">ç™» å½•</view>
      <text class="login-hint">é»˜è®¤å¯†ç ï¼š123456</text>
    </view>
  </view>

  <!-- å·²ç™»å½• - å•†å®¶ç®¡ç† -->
  <view wx:else class="merchant-content">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <view class="merchant-header">
      <view class="header-info">
        <text class="header-title">{{currentPage === 'orders' ? 'ğŸ“‹ è®¢å•ç®¡ç†' : currentPage === 'menu' ? 'ğŸ½ï¸ èœå“ç®¡ç†' : currentPage === 'suggestions' ? 'ğŸ’¡ å»ºè®®ç®¡ç†' : 'âš™ï¸ è®¾ç½®'}}</text>
        <text class="header-subtitle">{{currentPage === 'orders' ? 'å®æ—¶ç›‘å¬ä¸­ï¼Œæ–°è®¢å•è‡ªåŠ¨æ¨é€' : currentPage === 'menu' ? 'æ·»åŠ /åˆ é™¤èœå“ï¼Œå®æ—¶åŒæ­¥åˆ°é¡¾å®¢ç«¯' : 'æŸ¥çœ‹é¡¾å®¢æäº¤çš„èœå“å»ºè®®'}}</text>
      </view>
      <view class="header-actions">
        <view class="refresh-btn" bindtap="onRefresh">ğŸ”„</view>
        <view class="logout-btn" bindtap="onLogout">é€€å‡º</view>
      </view>
    </view>

    <!-- é¡µé¢åˆ‡æ¢æ ï¼šè®¢å•ç®¡ç† / èœå“ç®¡ç† / èœå“å»ºè®® / æ•°æ®ç®¡ç† -->
    <view class="page-switch-bar">
      <view class="page-switch-item {{currentPage === 'orders' ? 'active' : ''}}" bindtap="onSwitchToOrders">
        <text>ğŸ“‹ è®¢å•</text>
      </view>
      <view class="page-switch-item {{currentPage === 'menu' ? 'active' : ''}}" bindtap="onSwitchToMenu">
        <text>ğŸ½ï¸ èœå“</text>
      </view>
      <view class="page-switch-item {{currentPage === 'suggestions' ? 'active' : ''}}" bindtap="onSwitchToSuggestions">
        <text>ğŸ’¡ å»ºè®®</text>
      </view>
      <view class="page-switch-item {{currentPage === 'settings' ? 'active' : ''}}" bindtap="onSwitchToSettings">
        <text>âš™ï¸ è®¾ç½®</text>
      </view>
    </view>

    <!-- ====== è®¢å•ç®¡ç†é¡µé¢ ====== -->
    <view wx:if="{{currentPage === 'orders'}}" class="orders-page">
      <!-- è®¢å•çŠ¶æ€æ ‡ç­¾ -->
      <view class="tab-bar">
        <view class="tab-item {{currentTab === 'all' ? 'active' : ''}}" data-tab="all" bindtap="onTabChange">
          <text>å…¨éƒ¨</text>
          <text class="tab-count">({{orders.length}})</text>
        </view>
        <view class="tab-item {{currentTab === 'pending' ? 'active' : ''}}" data-tab="pending" bindtap="onTabChange">
          <text>å¾…åˆ¶ä½œ</text>
        </view>
        <view class="tab-item {{currentTab === 'cooking' ? 'active' : ''}}" data-tab="cooking" bindtap="onTabChange">
          <text>åˆ¶ä½œä¸­</text>
        </view>
        <view class="tab-item {{currentTab === 'done' ? 'active' : ''}}" data-tab="done" bindtap="onTabChange">
          <text>å·²å®Œæˆ</text>
        </view>
      </view>

      <!-- åŠ è½½ä¸­ -->
      <view wx:if="{{loading}}" class="loading-state">
        <text class="loading-text">åŠ è½½è®¢å•ä¸­...</text>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:elif="{{filteredOrders.length === 0}}" class="empty-merchant">
        <text class="empty-merchant-icon">ğŸ“­</text>
        <text class="empty-merchant-text">æš‚æ— è®¢å•</text>
        <text class="empty-merchant-desc">æ–°è®¢å•å°†è‡ªåŠ¨å‡ºç°åœ¨è¿™é‡Œ</text>
      </view>

      <!-- è®¢å•åˆ—è¡¨ -->
      <scroll-view wx:else class="order-scroll" scroll-y enhanced show-scrollbar="{{false}}">
        <view wx:for="{{filteredOrders}}" wx:key="_id" class="merchant-order-card {{item.status === 'å¾…åˆ¶ä½œ' ? 'status-pending' : item.status === 'åˆ¶ä½œä¸­' ? 'status-cooking' : 'status-done'}}">
          <!-- è®¢å•å¤´éƒ¨ -->
          <view class="merchant-order-header" data-id="{{item._id}}" bindtap="onOrderDetail">
            <view class="table-badge">
              <text class="table-badge-text">æ¡Œ{{item.tableNo}}</text>
            </view>
            <view class="order-meta">
              <text class="order-no">{{item.orderId}}</text>
              <text class="order-create-time">{{item.createTimeStr}}</text>
              <view wx:if="{{item.userName}}" class="user-info">
                <text class="user-name">ğŸ‘¤ {{item.userName}}</text>
              </view>
            </view>
            <view class="status-badge {{item.status === 'å¾…åˆ¶ä½œ' ? 'badge-pending' : item.status === 'åˆ¶ä½œä¸­' ? 'badge-cooking' : 'badge-done'}}">
              <text>{{item.status}}</text>
            </view>
          </view>

          <!-- è®¢å•å•†å“ -->
          <view class="merchant-order-body">
            <view wx:for="{{item.items}}" wx:for-item="food" wx:key="id" class="food-row {{food.isCustom ? 'food-row-custom' : ''}}">
              <text wx:if="{{food.isCustom}}" class="custom-tag">è‡ªåˆ›</text>
              <text class="food-name">{{food.name}}</text>
              <text class="food-count">x{{food.count}}</text>
              <text class="food-price">Â¥{{food.price * food.count}}</text>
            </view>
            <view wx:if="{{item.remark}}" class="remark-row">
              <text class="remark-label">ğŸ“ å¤‡æ³¨ï¼š</text>
              <text class="remark-content">{{item.remark}}</text>
            </view>
          </view>

          <!-- è®¢å•åº•éƒ¨ -->
          <view class="merchant-order-footer">
            <text class="order-total-price">åˆè®¡ï¼šÂ¥{{item.totalPrice}}</text>
            <view class="order-actions">
              <view wx:if="{{item.status === 'å¾…åˆ¶ä½œ'}}" class="action-btn action-start" data-id="{{item._id}}" catchtap="onStartCooking">
                å¼€å§‹åˆ¶ä½œ
              </view>
              <view wx:if="{{item.status === 'åˆ¶ä½œä¸­'}}" class="action-btn action-finish" data-id="{{item._id}}" catchtap="onFinishCooking">
                å®Œæˆå‡ºé¤
              </view>
              <view wx:if="{{item.status === 'å·²å®Œæˆ'}}" class="action-btn action-done">
                âœ… å·²å®Œæˆ
              </view>
              <!-- åˆ é™¤è®¢å•æŒ‰é’® -->
              <view class="action-btn action-delete" data-id="{{item._id}}" data-table="{{item.tableNo}}" catchtap="onDeleteOrder">
                ğŸ—‘ï¸ åˆ é™¤
              </view>
            </view>
          </view>
        </view>
        <view style="height: 40rpx;"></view>
      </scroll-view>
    </view>

    <!-- ====== èœå“ç®¡ç†é¡µé¢ ====== -->
    <view wx:if="{{currentPage === 'menu'}}" class="menu-manage">
      <!-- æ“ä½œæŒ‰é’®æ  -->
      <view class="menu-action-bar">
        <view class="menu-action-btn action-add-dish" bindtap="onShowAddDish">
          <text>â• æ·»åŠ èœå“</text>
        </view>
        <view class="menu-action-btn action-add-category" bindtap="onShowAddCategory">
          <text>ğŸ“ æ·»åŠ åˆ†ç±»</text>
        </view>
      </view>

      <!-- åˆ†ç±»åˆ—è¡¨ -->
      <view class="menu-section">
        <view class="menu-section-title">
          <text>åˆ†ç±»åˆ—è¡¨ ({{categories.length}}ä¸ª)</text>
        </view>
        <view class="category-manage-list">
          <view wx:for="{{categories}}" wx:key="_id" class="category-manage-item">
            <text class="cat-manage-icon">{{item.icon}}</text>
            <text class="cat-manage-name">{{item.name}}</text>
            <text class="cat-manage-id">ID: {{item.id}}</text>
            <view class="cat-manage-delete" data-id="{{item._id}}" data-name="{{item.name}}" catchtap="onDeleteCategory">
              <text>ğŸ—‘ï¸</text>
            </view>
          </view>
        </view>
      </view>

      <!-- èœå“åˆ—è¡¨ -->
      <view class="menu-section">
        <view class="menu-section-title">
          <text>èœå“åˆ—è¡¨ ({{menuList.length}}é“èœ)</text>
        </view>
        
        <!-- åŠ è½½ä¸­ -->
        <view wx:if="{{menuLoading}}" class="loading-state">
          <text class="loading-text">åŠ è½½èœå“ä¸­...</text>
        </view>

        <scroll-view wx:else class="menu-manage-scroll" scroll-y enhanced show-scrollbar="{{false}}">
          <view wx:for="{{menuList}}" wx:key="_id" class="dish-manage-card">
            <view class="dish-manage-info">
              <view class="dish-manage-top">
                <text class="dish-manage-name">{{item.name}}</text>
                <text class="dish-manage-price">Â¥{{item.price}}</text>
              </view>
              <view class="dish-manage-bottom">
                <text class="dish-manage-desc">{{item.description}}</text>
                <text class="dish-manage-category">åˆ†ç±»ID: {{item.categoryId}}</text>
              </view>
            </view>
            <view class="dish-manage-actions">
              <view class="dish-delete-btn" data-id="{{item._id}}" data-name="{{item.name}}" catchtap="onDeleteDish">
                <text>åˆ é™¤</text>
              </view>
            </view>
          </view>
          <view style="height: 40rpx;"></view>
        </scroll-view>
      </view>
    </view>

    <!-- ====== èœå“å»ºè®®ç®¡ç†é¡µé¢ ====== -->
    <view wx:if="{{currentPage === 'suggestions'}}" class="suggestion-manage">
      <!-- åŠ è½½ä¸­ -->
      <view wx:if="{{suggestionLoading}}" class="loading-state">
        <text class="loading-text">åŠ è½½èœå“å»ºè®®ä¸­...</text>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:elif="{{suggestionList.length === 0}}" class="empty-merchant">
        <text class="empty-merchant-icon">ğŸ’¡</text>
        <text class="empty-merchant-text">æš‚æ— èœå“å»ºè®®</text>
        <text class="empty-merchant-desc">é¡¾å®¢æäº¤çš„èœå“å»ºè®®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</text>
      </view>

      <!-- å»ºè®®åˆ—è¡¨ -->
      <scroll-view wx:else class="suggestion-scroll" scroll-y enhanced show-scrollbar="{{false}}">
        <view wx:for="{{suggestionList}}" wx:key="_id" class="suggestion-card {{item.status === 'å¾…å®¡æ ¸' ? 'suggestion-pending' : item.status === 'å·²ä¸Šæ¶' ? 'suggestion-approved' : 'suggestion-ignored'}}">
          <view class="suggestion-card-header">
            <view class="suggestion-card-info">
              <text class="suggestion-card-name">ğŸ½ï¸ {{item.name}}</text>
              <text class="suggestion-card-status status-{{item.status === 'å¾…å®¡æ ¸' ? 'pending' : item.status === 'å·²ä¸Šæ¶' ? 'approved' : 'ignored'}}">{{item.status}}</text>
            </view>
            <view wx:if="{{item.description}}" class="suggestion-card-desc">
              <text>ğŸ“ {{item.description}}</text>
            </view>
            <view class="suggestion-card-time">
              <text>æäº¤æ—¶é—´ï¼š{{item.createTimeStr}}</text>
            </view>
          </view>
          <!-- å¾…å®¡æ ¸çŠ¶æ€æ˜¾ç¤ºæ“ä½œæŒ‰é’® -->
          <view wx:if="{{item.status === 'å¾…å®¡æ ¸'}}" class="suggestion-card-actions">
            <view class="suggestion-approve-btn" data-id="{{item._id}}" data-name="{{item.name}}" data-desc="{{item.description}}" catchtap="onShowApproveSuggestion">
              âœ… é‡‡çº³ä¸Šæ¶
            </view>
            <view class="suggestion-ignore-btn" data-id="{{item._id}}" catchtap="onIgnoreSuggestion">
              âŒ å¿½ç•¥
            </view>
          </view>
        </view>
        <view style="height: 40rpx;"></view>
      </scroll-view>
    </view>

    <!-- ====== è®¾ç½®é¡µé¢ ====== -->
    <view wx:if="{{currentPage === 'settings'}}" class="settings-page">
      <view class="settings-section">
        <view class="settings-title">æ•°æ®ç®¡ç†</view>
        <view class="settings-item" bindtap="onCleanupData">
          <text class="settings-icon">ğŸ§¹</text>
          <text class="settings-text">æ¸…ç†é‡å¤æ•°æ®</text>
          <text class="settings-arrow">></text>
        </view>
        <view class="settings-desc">æ¸…ç†äº‘ç«¯é‡å¤çš„èœå“å’Œåˆ†ç±»æ•°æ®</view>
      </view>

      <view class="settings-section">
        <view class="settings-title">å…³äº</view>
        <view class="settings-item">
          <text class="settings-icon">ğŸ“±</text>
          <text class="settings-text">ç‰ˆæœ¬</text>
          <text class="settings-value">v1.0.0</text>
        </view>
      </view>
    </view>

  </view> <!-- é—­åˆ merchant-content -->

  <!-- ====== å…¨å±€å¼¹çª—ç»„ä»¶ ====== -->
  
  <!-- æ·»åŠ èœå“å¼¹çª— -->
  <view wx:if="{{showAddDishPopup}}" class="popup-mask" bindtap="onHideAddDish">
    <view class="popup-box" catchtap="onStopPropagation">
      <view class="popup-header">
        <text class="popup-title">â• æ·»åŠ æ–°èœå“</text>
      </view>
      <view class="popup-body">
        <view class="popup-field">
          <text class="popup-label">èœå“åç§° *</text>
          <input class="popup-input" placeholder="è¯·è¾“å…¥èœå“åç§°" value="{{newDishName}}" bindinput="onNewDishNameInput" />
        </view>
        <view class="popup-field">
          <text class="popup-label">ä»·æ ¼(å…ƒ) *</text>
          <input class="popup-input" type="digit" placeholder="è¯·è¾“å…¥ä»·æ ¼" value="{{newDishPrice}}" bindinput="onNewDishPriceInput" />
        </view>
        <view class="popup-field">
          <text class="popup-label">æè¿°</text>
          <input class="popup-input" placeholder="è¯·è¾“å…¥èœå“æè¿°" value="{{newDishDesc}}" bindinput="onNewDishDescInput" />
        </view>
        <view class="popup-field">
          <text class="popup-label">æ‰€å±åˆ†ç±»</text>
          <picker mode="selector" range="{{categories}}" range-key="name" bindchange="onNewDishCategoryChange">
            <view class="popup-picker">
              <text>{{categories[selectedCategoryIndex].name || 'è¯·é€‰æ‹©åˆ†ç±»'}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
      </view>
      <view class="popup-actions">
        <view class="popup-cancel" bindtap="onHideAddDish">å–æ¶ˆ</view>
        <view class="popup-confirm" bindtap="onConfirmAddDish">ç¡®è®¤æ·»åŠ </view>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ åˆ†ç±»å¼¹çª— -->
  <view wx:if="{{showAddCategoryPopup}}" class="popup-mask" bindtap="onHideAddCategory">
    <view class="popup-box" catchtap="onStopPropagation">
      <view class="popup-header">
        <text class="popup-title">ğŸ“ æ·»åŠ æ–°åˆ†ç±»</text>
      </view>
      <view class="popup-body">
        <view class="popup-field">
          <text class="popup-label">åˆ†ç±»åç§° *</text>
          <input class="popup-input" placeholder="å¦‚ï¼šçƒ§çƒ¤ã€ç«é”…" value="{{newCategoryName}}" bindinput="onNewCategoryNameInput" />
        </view>
        <view class="popup-field">
          <text class="popup-label">åˆ†ç±»å›¾æ ‡ (emoji)</text>
          <input class="popup-input" placeholder="å¦‚ï¼šğŸ–ğŸ²ï¼Œé»˜è®¤ğŸ½ï¸" value="{{newCategoryIcon}}" bindinput="onNewCategoryIconInput" />
        </view>
      </view>
      <view class="popup-actions">
        <view class="popup-cancel" bindtap="onHideAddCategory">å–æ¶ˆ</view>
        <view class="popup-confirm" bindtap="onConfirmAddCategory">ç¡®è®¤æ·»åŠ </view>
      </view>
    </view>
  </view>

  <!-- é‡‡çº³ä¸Šæ¶å¼¹çª— -->
  <view wx:if="{{showApproveSuggestionPopup}}" class="popup-mask" bindtap="onHideApproveSuggestion">
    <view class="popup-box" catchtap="onStopPropagation">
      <view class="popup-header">
        <text class="popup-title">âœ… é‡‡çº³ä¸Šæ¶</text>
      </view>
      <view class="popup-body">
        <view class="popup-field">
          <text class="popup-label">èœå“åç§° *</text>
          <input class="popup-input" placeholder="è¯·è¾“å…¥èœå“åç§°" value="{{approvingSuggestion.name}}" bindinput="onApproveDishNameInput" />
        </view>
        <view wx:if="{{approvingSuggestion.description}}" class="popup-field">
          <text class="popup-label">é¡¾å®¢è¯´æ˜</text>
          <view class="popup-static-text">{{approvingSuggestion.description}}</view>
        </view>
        <view class="popup-field">
          <text class="popup-label">å®šä»·(å…ƒ) *</text>
          <input class="popup-input" type="digit" placeholder="è¯·è¾“å…¥èœå“ä»·æ ¼" value="{{approveDishPrice}}" bindinput="onApprovePriceInput" />
        </view>
        <view class="popup-field">
          <text class="popup-label">æ‰€å±åˆ†ç±»</text>
          <picker mode="selector" range="{{categories}}" range-key="name" bindchange="onApproveCategoryChange">
            <view class="popup-picker">
              <text>{{categories[selectedApproveCategoryIndex].name || 'è¯·é€‰æ‹©åˆ†ç±»'}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
      </view>
      <view class="popup-actions">
        <view class="popup-cancel" bindtap="onHideApproveSuggestion">å–æ¶ˆ</view>
        <view class="popup-confirm" bindtap="onConfirmApproveSuggestion">ç¡®è®¤ä¸Šæ¶</view>
      </view>
    </view>
  </view>

</view> <!-- é—­åˆ merchant-page -->