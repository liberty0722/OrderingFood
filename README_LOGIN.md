# 微信小程序角色登录和数据隔离配置说明

## 功能概述

已成功为微信小程序添加角色登录功能，实现了顾客和商家的数据隔离。

## 主要改动

### 1. 新增登录页面
- `pages/login/login.js` - 登录页面逻辑
- `pages/login/login.json` - 登录页面配置
- `pages/login/login.wxml` - 登录页面视图
- `pages/login/login.wxss` - 登录页面样式

### 2. 云函数
- `cloudfunctions/login/` - 登录验证云函数
- `cloudfunctions/initData/` - 初始化数据云函数

### 3. 修改的文件
- `app.js` - 添加用户登录状态管理
- `app.json` - 注册登录页面
- `pages/mine/` - 添加登录状态显示和登录入口
- `pages/cart/cart.js` - 结算前检查登录状态
- `pages/order/order.js` - 提交订单前检查登录状态
- `pages/merchant/merchant.js` - 商家权限验证

## 数据隔离机制

### 订单数据隔离
- **顾客**：只能查看自己创建的订单（通过 `_openid` 自动隔离）
- **商家**：可以查看所有订单

### 用户角色
- **customer（顾客）**：微信授权登录
- **merchant（商家）**：密码登录

## 部署步骤

### 1. 创建数据库集合
在微信云开发控制台创建以下集合：
- `users` - 用户信息（权限：仅创建者可读写）
- `merchants` - 商家账户（权限：所有用户可读，仅创建者可写）
- `orders` - 订单信息（权限：仅创建者可读写）

### 2. 上传并部署云函数
在微信开发者工具中：
1. 右键点击 `cloudfunctions/login` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 同样部署 `cloudfunctions/initData`

### 3. 初始化商家账户
调用 `initData` 云函数：
```javascript
wx.cloud.callFunction({
  name: 'initData',
  data: { action: 'initMerchant' }
})
```
默认商家密码：`admin123`

### 4. 配置数据库权限
在云开发控制台设置集合权限：
- `users`：所有用户可读，仅创建者可读写
- `merchants`：所有用户可读，仅管理员可写
- `orders`：所有用户可读，仅创建者可读写

## 使用说明

### 顾客登录
1. 打开小程序，点击"我的"页面
2. 点击"顾客登录"按钮
3. 授权微信信息
4. 登录成功后可以正常点餐下单

### 商家登录
1. 打开小程序，点击"我的"页面
2. 点击"商家登录"按钮
3. 输入商家密码（默认：admin123）
4. 登录成功后可以查看所有订单和进入商家管理端

### 数据隔离验证
- 顾客A下单的订单，顾客B无法查看
- 商家可以查看所有顾客的订单
- 每个角色的数据完全隔离

## 注意事项

1. 首次部署需要调用 `initData` 云函数初始化商家账户
2. 商家密码建议在初始化后修改
3. 云函数需要安装依赖后才能正常使用
4. 数据库权限设置正确才能保证数据安全
